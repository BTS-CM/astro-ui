import{$ as q,u as be,p as Y,v as z,q as H,j as e,C as W,b as J,c as X,d as ge,g as G,A as K,I as b,h as Q,B as Z,f as ye}from"./CurrentUser.c838994d.js";import{r as o}from"./index.178a5b5e.js";import{u as ve,F as we,a as d,b as u,c as m,d as h,f as x,e as w}from"./form.40198e39.js";import{F as _e}from"./index.esm.0bfbf988.js";import{S as ee,a as se,b as re,c as ae,d as O}from"./select.b57c21b8.js";import{A as C,a as F}from"./avatar.acdc9abe.js";import{h as N,b as le}from"./common.6cf182e8.js";import{c as $e}from"./User.5f5c85ce.js";import{D as Ne}from"./DeepLinkDialog.96736934.js";import"./index.6a2b73ba.js";import"./index.cc31bd08.js";function Se(L){var c=new Date(L),i=new Date,g=c-i,S=Math.round(g/1e3/60/60);return S}function Pe(L){const c=ve({defaultValues:{account:""}}),i=o.useSyncExternalStore(q.subscribe,q.get,()=>!0);be(i&&i.chain?i.chain:"bitshares");const g=o.useSyncExternalStore(Y.subscribe,Y.get,()=>!0),S=o.useSyncExternalStore(z.subscribe,z.get,()=>!0),[U,te]=o.useState(0);o.useEffect(()=>{if(S&&S.length){const r=S.find(n=>n[0]===72),t=N(r[1].fee,5);te(t)}},[S]);const A=o.useSyncExternalStore(H.subscribe,H.get,()=>!0),[l,ne]=o.useState(null),[s,oe]=o.useState(null);o.useEffect(()=>{async function r(){console.log("Parsing url parameters");const t=new URLSearchParams(window.location.search),p=Object.fromEntries(t.entries()).id;if(p){const v=A.find(M=>M.id===p);return v?(console.log({msg:"Setting found offer.",foundOffer:v}),v):(console.log("Setting default first offer"),A[0])}else return console.log("No market parameters found."),A[0]}A&&A.length&&r().then(t=>{const n=g.find(p=>p.id===t.asset_type);ne(n),oe(t)})},[A]);const[P,ie]=o.useState(),[k,ce]=o.useState([]);o.useEffect(()=>{let r;return i&&i.id&&(r=$e([i.chain,i.id]).subscribe(({data:n,error:p,loading:v})=>{n&&!p&&!v&&(ce(n.map(M=>M.asset_id)),ie(n))})),()=>{r&&r()}},[i]);const[f,de]=o.useState(null),B=o.useMemo(()=>s&&s.acceptable_collateral?s.acceptable_collateral.map(r=>r[0]).map(r=>g.find(n=>n.id===r)):[],[s,g]),ue=({index:r,style:t})=>{const n=B[r];return e.jsx(O,{value:n.id,style:t,children:`${n.symbol} (${n.id})`})},$=o.useMemo(()=>s&&l?N(s.current_balance,l.precision):0,[s,l]),D=o.useMemo(()=>s&&l?N(s.min_deal_amount,l.precision):1,[s,l]),[R,E]=o.useState(D??1),[_,me]=o.useState(0),[j,T]=o.useState();o.useEffect(()=>{const r=setTimeout(()=>{me(R)},1e3);return()=>clearTimeout(r)},[R]),o.useEffect(()=>{if(!$){T(0);return}if(_)if(_>$)T($),E($);else if(_<D)T(D),E(D);else if(_.toString().split(".").length>1&&_.toString().split(".")[1].length>l.precision){const r=parseFloat(_).toFixed(l.precision);T(r),E(r)}else T(_)},[_,$]);const a=o.useMemo(()=>{if(f&&k&&g&&P){const r=g.find(n=>n.id===f),t=P.find(n=>n.asset_id===f);return{amount:t?N(t.amount,r.precision):0,holding:k.includes(f),symbol:r.symbol,precision:r.precision,id:r.id,isBitasset:!!r.bitasset_data_id}}},[f,k,g,P]),he=o.useMemo(()=>{if(s){let r=s.max_duration_seconds/3600,t=new Date;t.setHours(t.getHours()+r);let n=`${t.getDate()}/${t.getMonth()+1}/${t.getFullYear()}`;return r>24?`${Math.floor(r/24)} days (due by ${n})`:`${r.toFixed(r<1?2:0)} hours (due by ${n})`}},[s]),xe=o.useMemo(()=>{if(s){const r=Se(s.auto_disable_time);let t=new Date(s.auto_disable_time),n=`${t.getDate()}/${t.getMonth()+1}/${t.getFullYear()}`;return r>24?`${Math.floor(r/24)} days (on ${n})`:`${r.toFixed(r<1?2:0)} hours (on ${n})`}},[s]),I=o.useMemo(()=>{if(j&&a&&s){let r=0;const t=s.acceptable_collateral.find(v=>v[0]===a.id),n=t[1].base,p=t[1].quote;if(p.asset_id===a.id){const v=N(p.amount,a.precision)/N(n.amount,g.find(M=>M.id===n.asset_id).precision);r+=j*v}return r.toFixed(a.precision)}},[j,a,s]),[fe,V]=o.useState(!1),[y,je]=o.useState(),pe=o.useMemo(()=>{if(y){if(y==="no_auto_repayment")return 0;if(y==="only_full_repayment")return 1;if(y==="allow_partial_repayment")return 2}},[y]);return e.jsx(e.Fragment,{children:e.jsxs("div",{className:"container mx-auto mt-5 mb-5",children:[e.jsx("div",{className:"grid grid-cols-1 gap-3",children:e.jsxs(W,{children:[e.jsxs(J,{className:"pb-1",children:[e.jsx(X,{children:s?e.jsxs(e.Fragment,{children:["ðŸ¦ Viewing offer #",s.id," created by"," ",s.owner_name??"?"," (",s.owner_account,")"]}):"loading terms of offer..."}),e.jsxs(ge,{children:["This is an user created credit offer on the Bitshares DEX.",e.jsx("br",{}),"Thoroughly read the terms of the offer before proceeding to Beet."]})]}),e.jsx(G,{children:e.jsx("div",{className:"grid grid-cols-1 gap-2 mt-3",children:e.jsx("div",{className:"col-span-1",children:e.jsx(we,{...c,children:e.jsxs("form",{onSubmit:()=>{V(!0),event.preventDefault()},children:[e.jsx(d,{control:c.control,name:"borrowerAccount",render:({field:r})=>e.jsxs(u,{children:[e.jsx(m,{children:"Borrowing account"}),e.jsx(h,{children:e.jsxs("div",{className:"grid grid-cols-8 mt-4",children:[e.jsx("div",{className:"col-span-1 ml-5",children:i&&i.username?e.jsx(K,{size:40,name:i.username,extra:"Target",expression:{eye:"normal",mouth:"open"},colors:["#92A1C6","#146A7C","#F0AB3D","#C271B4","#C20D90"]}):e.jsx(C,{children:e.jsx(F,{children:"?"})})}),e.jsx("div",{className:"col-span-7",children:e.jsx(b,{disabled:!0,placeholder:"Bitshares account (1.2.x)",className:"mb-1 mt-1",value:i?`${i.username} (${i.id})`:"",readOnly:!0})})]})}),e.jsx(x,{children:"The account which will broadcast the credit offer accept operation."}),e.jsx(w,{})]})}),e.jsx(d,{control:c.control,name:"lenderAccount",render:({field:r})=>e.jsxs(u,{children:[e.jsx(m,{children:e.jsxs("div",{className:"grid grid-cols-2 mt-4",children:[e.jsx("div",{className:"col-span-1",children:"Lending account"}),e.jsx("div",{className:"col-span-1 text-right",children:s?e.jsxs("a",{href:`https://blocksights.info/#/accounts/${s.owner_name}`,target:"_blank",children:["View ",s.owner_name,"'s account"]}):null})]})}),e.jsx(h,{children:e.jsxs("div",{className:"grid grid-cols-8 mt-4",children:[e.jsx("div",{className:"col-span-1 ml-5",children:s&&s.owner_name?e.jsx(K,{size:40,name:s.owner_name,extra:"Target",expression:{eye:"normal",mouth:"open"},colors:["#92A1C6","#146A7C","#F0AB3D","#C271B4","#C20D90"]}):e.jsx(C,{children:e.jsx(F,{children:"?"})})}),e.jsx("div",{className:"col-span-7",children:e.jsx(b,{disabled:!0,placeholder:"Bitshares account (1.2.x)",className:"mb-1 mt-1",value:s?`${s.owner_name} (${s.owner_account})`:"",readOnly:!0})})]})}),e.jsx(x,{children:`This is the user from whom you'll be borrowing ${l?.symbol} from.`}),e.jsx(w,{})]})}),e.jsx(d,{control:c.control,name:"amountAvailable",render:({field:r})=>e.jsxs(u,{children:[e.jsx(m,{children:l&&s?`Amount of ${l.symbol} (
                                      ${s.asset_type}) available to
                                      borrow from this lender`:"loading..."}),e.jsx(h,{children:e.jsxs("div",{className:"grid grid-cols-8 mt-4",children:[e.jsx("div",{className:"col-span-1 ml-5",children:l?e.jsx(C,{children:e.jsx(F,{children:e.jsx("div",{className:"text-sm",children:l.bitasset_data_id?"MPA":"UIA"})})}):e.jsx(C,{children:e.jsx(F,{children:"?"})})}),e.jsx("div",{className:"col-span-7",children:e.jsx(b,{disabled:!0,placeholder:"Bitshares account (1.2.x)",className:"mb-1 mt-1",value:s&&l?`${N(s.current_balance,l.precision)} ${l.symbol}`:"loading...",readOnly:!0})})]})}),e.jsx(x,{children:`${s?.owner_name} is generously offering to lend you this much ${l?.symbol}, assuming you agree to their terms.`})]})}),e.jsx(d,{control:c.control,name:"backingCollateral",render:({field:r})=>e.jsxs(u,{children:[e.jsx(m,{children:e.jsx("div",{className:"grid grid-cols-2 mt-3",children:e.jsx("div",{className:"mt-1",children:"Backing collateral for credit deal"})})}),e.jsx(h,{children:e.jsxs("div",{className:"grid grid-cols-8",children:[e.jsx("div",{className:"col-span-1 ml-5 mt-1",children:l?e.jsx(C,{children:e.jsx(F,{children:e.jsxs("div",{className:"text-sm",children:[a?null:"?",a&&a.isBitasset?"MPA":null,a&&!a.isBitasset?"UIA":null]})})}):e.jsx(C,{children:e.jsx(F,{children:"?"})})}),e.jsx("div",{className:"col-span-7 mt-2",children:e.jsxs(ee,{onValueChange:t=>{de(t)},children:[e.jsx(se,{className:"mb-1",children:e.jsx(re,{placeholder:a?`${a.symbol} (${a.id})`:"Select your backing collateral.."})}),e.jsx(ae,{className:"bg-white",children:B&&B.length?e.jsx(_e,{height:100,itemCount:B.length,itemSize:35,className:"w-full",initialScrollOffset:f?B.map(t=>t.id).indexOf(f.id)*35:0,children:ue}):null})]})})]})}),e.jsx(x,{children:`To borrow ${a?.symbol} from ${s?.owner_name}, choose between the above accepted backing collateral assets.`}),k&&f&&!k.includes(f)?e.jsx(w,{children:"Account doesn't hold this backing collateral asset."}):null]})}),e.jsx(d,{control:c.control,name:"borrowAmount",render:({field:r})=>e.jsxs(u,{children:[e.jsx(m,{children:e.jsxs("div",{className:"grid grid-cols-2 gap-1 mt-5",children:[e.jsx("div",{className:"col-span-1",children:`Amount of ${l?l.symbol:"?"} you plan on borrowing`}),e.jsx("div",{className:"col-span-1 text-right",children:`Available: ${D??"?"} to ${$??"?"} ${l?.symbol}`})]})}),$?e.jsx(h,{onChange:t=>{const n=t.target.value;/^[0-9]*\.?[0-9]*$/.test(n)&&E(n)},children:e.jsx(b,{value:R,className:"mb-3"})}):e.jsx(h,{children:e.jsx(b,{disabled:!0,value:0,className:"mb-3",readOnly:!0})}),e.jsx(x,{children:`Input the amount of ${l?.symbol} you'd like to borrow from ${s?.owner_name}.`}),e.jsx(w,{})]})}),e.jsx(d,{control:c.control,name:"repayMethod",render:({field:r})=>e.jsxs(u,{children:[e.jsx(m,{children:e.jsx("div",{className:"grid grid-cols-2 mt-3",children:e.jsx("div",{className:"mt-1",children:"Credit offer repay method"})})}),e.jsx(h,{children:e.jsxs(ee,{onValueChange:t=>{je(t)},children:[e.jsx(se,{className:"mb-1",children:e.jsx(re,{placeholder:"Select your repay method.."})}),e.jsxs(ae,{className:"bg-white",children:[e.jsx(O,{value:"no_auto_repayment",children:"No auto repayment"}),e.jsx(O,{value:"only_full_repayment",children:"Only full repayment"}),e.jsx(O,{value:"allow_partial_repayment",children:"Allow partial repayment"})]})]})}),e.jsx(x,{children:"Select between the different repayment methods."}),y?e.jsxs(w,{children:[y==="no_auto_repayment"?"You will not automatically repay this loan.":null,y==="only_full_repayment"?"You will automatically repay this loan in full when your account balance is sufficient.":null,y==="allow_partial_repayment"?"You will automatically repay this loan as much as possible using your available account balance.":null]}):null]})}),f?e.jsx(d,{control:c.control,name:"requiredCollateralAmount",render:({field:r})=>e.jsxs(u,{children:[e.jsx(m,{children:e.jsxs("div",{className:"grid grid-cols-2 gap-1 mt-5",children:[e.jsx("div",{className:"col-span-1",children:"Required collateral"}),e.jsx("div",{className:"col-span-1 text-right",children:a?`Your current balance: ${a.amount} ${a.symbol}`:"Loading balance..."})]})}),e.jsx(h,{children:e.jsx(b,{disabled:!0,value:`${I??"0"} ${a?a.symbol:""}`,className:"mb-3",readOnly:!0})}),e.jsx(x,{children:j&&l?`In order to borrow ${j??""} ${l?l.symbol:""} you'll
                                need to provide the following amount of collateral to
                                secure the deal.`:"Enter a valid borrow amount to calculate required collateral."}),a&&a.holding&&a.amount<I?e.jsx(w,{children:`Your account has an insufficient ${a.symbol} balance. You'll need at least ${(I-a.amount).toFixed(a.precision)} more ${a.symbol}.`}):null,a&&!a.holding?e.jsx(w,{children:"Your account does not hold this asset. Try another form of backing collateral if possible."}):null]})}):null,e.jsx(d,{control:c.control,name:"repayPeriod",render:({field:r})=>e.jsxs(u,{children:[e.jsx(m,{children:e.jsx("div",{className:"grid grid-cols-2 gap-1 mt-5",children:e.jsx("div",{className:"col-span-1",children:"Repay period"})})}),e.jsx(h,{children:e.jsx(b,{disabled:!0,value:he??"loading...",className:"mb-3",readOnly:!0})}),e.jsx(x,{children:"The maximum duration of the credit deal; repay the loan within this period to avoid loss of collateral."})]})}),e.jsx(d,{control:c.control,name:"offerValidity",render:({field:r})=>e.jsxs(u,{children:[e.jsx(m,{children:e.jsx("div",{className:"grid grid-cols-2 gap-1 mt-5",children:e.jsx("div",{className:"col-span-1",children:"Credit offer expiry"})})}),e.jsx(h,{children:e.jsx(b,{disabled:!0,value:xe??"Loading...",className:"mb-3",readOnly:!0})}),e.jsx(x,{children:"When this offer will no longer exist."})]})}),e.jsx(d,{control:c.control,name:"estimatedFee",render:({field:r})=>e.jsxs(u,{children:[e.jsx(m,{children:e.jsxs("div",{className:"grid grid-cols-2 gap-1 mt-5",children:[e.jsx("div",{className:"col-span-1",children:"Estimated borrow fee"}),e.jsx("div",{className:"col-span-1 text-right",children:s?`${s.fee_rate/1e4}% of borrowed
                                    amount`:"Loading borrow fee.."})]})}),e.jsx(h,{children:e.jsx(b,{disabled:!0,value:j?`${j*.01} ${l?l.symbol:"?"}`:`0 ${l?l.symbol:"?"}`,className:"mb-3",readOnly:!0})}),e.jsx(x,{children:`This is how much ${l?l.symbol:"?"} that ${s?s.owner_name:"?"} will earn once this deal has completed.`}),e.jsx(w,{})]})}),e.jsx(d,{control:c.control,disabled:!0,name:"fee",render:({field:r})=>e.jsxs(u,{children:[e.jsx(m,{children:"Network fee"}),e.jsx(b,{disabled:!0,value:`${U??"?"} BTS`,label:"fees",readOnly:!0}),e.jsx(x,{children:"The cost to broadcast your credit deal operation onto the network."}),i&&i.id===i.referrer?e.jsxs(w,{children:["LTM rebate: ",.8*U," BTS (vesting)"]}):null]})})]})})})})}),e.jsx(Q,{children:a&&!a.holding||a&&a.holding&&a.amount<I?e.jsx(Z,{disabled:!0,children:"Submit"}):e.jsx(Z,{onClick:()=>V(!0),children:"Submit"})})]})}),fe?e.jsx(Ne,{operationName:"credit_offer_accept",username:i.username,usrChain:i.chain,userID:i.id,dismissCallback:V,headerText:`Borrowing ${j} ${l.symbol} from ${s.owner_name} (${s.owner_account})`,trxJSON:[{borrower:i.id,offer_id:s.id,borrow_amount:{amount:le(j,l.precision),asset_id:l.id},collateral:{amount:le(I,a.precision),asset_id:a.id},max_fee_rate:s.fee_rate,min_duration_seconds:s.max_duration_seconds,extensions:{auto_repay:pe??0}}]},`Borrowing${j}${l.symbol}from${s.owner_name}(${s.owner_account})`):null,e.jsx("div",{className:"grid grid-cols-1 mt-5",children:e.jsxs(W,{children:[e.jsx(J,{children:e.jsx(X,{children:"Risks of Peer-to-Peer Loans"})}),e.jsxs(G,{className:"text-sm",children:["Peer-to-peer lending involves certain risks, including:",e.jsxs("ul",{className:"ml-2 list-disc [&>li]:mt-2 pl-2",children:[e.jsx("li",{children:"Collateral Risk: As a borrower, you may fail to repay the loan on time, forfeiting the loan collateral in full."}),e.jsx("li",{children:"Liquidity Risk: If you sell the assets you borrow, it may not be possible to re-acquire the assets in time to repay the loan, or you may do so at a loss."}),e.jsx("li",{children:"Platform Risk: If an asset's owner company goes out of business and ceases an exchange backed asset's operation, you could lose funds."}),e.jsx("li",{children:"User Risk: As credit offers are fully user generated, you could be interacting with untrustworthy assets or users who put funds at risk."}),e.jsx("li",{children:"Network Risk: Whilst blockchain downtime is very rare, it's a risk to consider when creating credit deals which span a period of time. Auto loan repay methods are available to offset such risk."})]})]}),e.jsx(Q,{className:"text-sm",children:"Please consider these risks and thoroughly evaluate the terms of offers before proceeding with a credit deal."})]})}),e.jsx("div",{className:"grid grid-cols-1 mt-5",children:i&&i.username&&i.username.length?e.jsx(ye,{usr:i}):null})]})})}export{Pe as default};
